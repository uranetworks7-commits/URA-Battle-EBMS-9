<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Money Transfer</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #051933, #0a1a2f, #112b4a);
      color: #f1f5ff;
      text-align: center;
      padding: 30px;
    }

    h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 30px;
      color: #4fc3f7;
      margin-bottom: 20px;
      text-shadow: 0px 0px 8px rgba(79,195,247,0.9);
    }

    input {
      padding: 12px;
      margin: 8px;
      width: 270px;
      border: 2px solid #4fc3f7;
      border-radius: 8px;
      background: #0f1f39;
      color: #f1f5ff;
      font-size: 15px;
      outline: none;
      transition: 0.3s;
    }
    input:focus {
      border-color: #29b6f6;
      box-shadow: 0px 0px 12px #29b6f6;
    }

    button {
      padding: 12px 25px;
      margin: 15px;
      cursor: pointer;
      background: linear-gradient(90deg, #1565c0, #1e88e5);
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      transition: 0.3s;
      box-shadow: 0px 0px 15px rgba(41,182,246,0.6);
    }
    button:hover {
      background: linear-gradient(90deg, #1e88e5, #42a5f5);
      box-shadow: 0px 0px 20px rgba(41,182,246,0.9);
    }

    /* Popup */
    #popup {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      z-index:1000;
    }
    #popupContent {
      background:rgba(15,31,57,0.95);
      padding:25px;
      border-radius:18px;
      width:340px;
      margin:120px auto;
      position:relative;
      color:#f1f5ff;
      box-shadow: 0px 0px 25px rgba(79,195,247,0.9);
      backdrop-filter: blur(8px);
      animation: popUp 0.5s ease;
    }
    @keyframes popUp {
      from {transform:scale(0.7); opacity:0;}
      to {transform:scale(1); opacity:1;}
    }
    #closeBtn {
      position:absolute;
      top:8px; right:12px;
      cursor:pointer;
      font-size:18px;
      color:#ef5350;
    }

    /* Modern Loading Bar */
    #progressContainer {
      width:100%;
      background:#1c2c44;
      border-radius:12px;
      margin-top:15px;
      height:14px;
      overflow:hidden;
    }
    #progress {
      height:100%;
      width:0%;
      background: linear-gradient(90deg,#29b6f6,#4fc3f7,#81d4fa);
      border-radius:12px;
      transition: width 0.4s ease;
    }

    /* Success, Fail, Security Alert */
    #successBox, #failedBox, #securityBox {
      display:none;
      margin-top:15px;
      padding:15px;
      border-radius:10px;
      font-weight:bold;
      font-size:14px;
      animation: fadeIn 0.6s ease-in-out;
    }
    #successBox {
      background: rgba(56, 142, 60, 0.2);
      color: #81c784;
      border:1px solid #66bb6a;
      text-shadow:0px 0px 6px #66bb6a;
    }
    #failedBox {
      background: rgba(211, 47, 47, 0.2);
      color: #ef9a9a;
      border:1px solid #ef5350;
      text-shadow:0px 0px 6px #ef5350;
    }
    #securityBox {
      background: rgba(255, 214, 0, 0.15);
      color: #ffeb3b;
      border:1px solid #fdd835;
      text-shadow:0px 0px 6px #ffeb3b;
    }

    /* Processing animation */
    .spinner {
      margin: 12px auto;
      border: 4px solid #1c2c44;
      border-top: 4px solid #4fc3f7;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg);} }

    .processing-dots::after {
      content: '';
      display: inline-block;
      animation: dots 1.5s steps(3, end) infinite;
    }
    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }

    @keyframes fadeIn {
      from {opacity:0;}
      to {opacity:1;}
    }
  </style>
</head>
<body>

  <h2>üí∏ Money Transfer</h2>
  <input type="text" id="sender" placeholder="Sender Accountname"><br>
  <input type="text" id="receiver" placeholder="Receiver Chat Name"><br>
  <input type="number" id="amount" placeholder="Amount"><br>
  <button id="transferBtn">üöÄ Transfer</button>

  <!-- Popup -->
  <div id="popup">
    <div id="popupContent">
      <span id="closeBtn">‚ùå</span>
      <h3 id="popupTitle"></h3>
      <div class="spinner" id="spinner"></div>
      <p id="popupMessage"></p>
      <div id="progressContainer"><div id="progress"></div></div>
      <div id="successBox"></div>
      <div id="failedBox"></div>
      <div id="securityBox"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBpvng4Am-rhTPwSvWKxAGN2WCqBwsoAaM",
      authDomain: "bitcoin-fa4b2.firebaseapp.com",
      databaseURL: "https://bitcoin-fa4b2-default-rtdb.firebaseio.com",
      projectId: "bitcoin-fa4b2",
      storageBucket: "bitcoin-fa4b2.appspot.com",
      messagingSenderId: "311271969444",
      appId: "1:311271969444:web:7fb50ae0439b9bde600c31"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function openPopup(title, msg, showSpinner=true) {
      document.getElementById("popupTitle").innerText = title;
      document.getElementById("popupMessage").innerText = msg;
      document.getElementById("popup").style.display = "block";
      document.getElementById("successBox").style.display = "none";
      document.getElementById("failedBox").style.display = "none";
      document.getElementById("securityBox").style.display = "none";
      document.getElementById("progress").style.width = "0";
      document.getElementById("spinner").style.display = showSpinner ? "block" : "none";
    }
    function closePopup() { document.getElementById("popup").style.display = "none"; }
    document.getElementById("closeBtn").addEventListener("click", closePopup);

    async function findUserByAccountName(accountname) {
      const snap = await get(ref(db, 'users'));
      if (!snap.exists()) return null;
      let found = null;
      snap.forEach(userSnap => {
        if ((userSnap.val()["accountname"] || "").trim().toLowerCase() === accountname.trim().toLowerCase()) {
          found = { key: userSnap.key, data: userSnap.val() };
        }
      });
      return found;
    }

    async function findUserByChatName(chatName) {
      const snap = await get(ref(db, 'users'));
      if (!snap.exists()) return null;
      let found = null;
      snap.forEach(userSnap => {
        if ((userSnap.val()["Chat Name "] || "").trim().toLowerCase() === chatName.trim().toLowerCase()) {
          found = { key: userSnap.key, data: userSnap.val() };
        }
      });
      return found;
    }

    async function transferMoney() {
      try {
        const senderAccountName = document.getElementById("sender").value.trim();
        const receiverChatName = document.getElementById("receiver").value.trim();
        const amount = parseFloat(document.getElementById("amount").value);

        if(!senderAccountName || !receiverChatName || !amount) {
          openPopup("‚ö†Ô∏è Error","Please fill all fields!",false);
          return;
        }

        const sender = await findUserByAccountName(senderAccountName);
        if(!sender) { openPopup("‚ùå Failed","Sender not found: " + senderAccountName,false); return; }

        const receiver = await findUserByChatName(receiverChatName);
        if(!receiver) { openPopup("‚ùå Failed","Receiver not found: " + receiverChatName,false); return; }

        let senderBalance = sender.data.usdBalance || 0;
        let receiverBalance = receiver.data.usdBalance || 0;

        if(amount > senderBalance) {
          openPopup("üí∞ Insufficient Balance","You don't have enough funds.",false);
          return;
        }

        // Show processing popup
        openPopup("Processing","Transaction in progress",true);
        document.getElementById("popupMessage").classList.add("processing-dots");

        let progress = document.getElementById("progress");
        let width = 0;
        let interval = setInterval(()=>{
          if(width < 100){
            width += 5;
            progress.style.width = width+"%";
          }
        }, 500);

        // Simulate delay + security check
        setTimeout(async ()=>{
          clearInterval(interval);

          // üîí Security Check: fetch sender again
          const freshSender = await findUserByAccountName(senderAccountName);
          if (!freshSender || freshSender.data.usdBalance !== senderBalance) {
            document.getElementById("popupMessage").classList.remove("processing-dots");
            document.getElementById("spinner").style.display = "none";
            document.getElementById("securityBox").style.display = "block";
            document.getElementById("securityBox").innerHTML = `
              üö® <b>Security Alert</b><br>
              System has detected abnormal activities.<br>
              Transaction cancelled By URA Security üì¢.
            `;
            return;
          }

          // ‚úÖ Update balances
          await update(ref(db,'users/'+sender.key),{usdBalance: senderBalance-amount});
          await update(ref(db,'users/'+receiver.key),{usdBalance: receiverBalance+amount});

          const id = Math.floor(10000000 + Math.random()*90000000);
          const now = new Date().toLocaleString();
          document.getElementById("popupMessage").classList.remove("processing-dots");
          document.getElementById("spinner").style.display = "none";
          document.getElementById("successBox").style.display = "block";
          document.getElementById("successBox").innerHTML = `
            ‚úÖ <b>Transfer Successful!</b><br><br>
            From: <b>${sender.data.accountname}</b><br>
            To: <b>${receiver.data["Chat Name "]}</b><br>
            Amount: <b>$${amount}</b><br>
            Time: ${now}<br>
            Transfer ID: <b>${id}</b>
          `;
        },7000);
      } catch (err) {
        console.error(err);
        openPopup("‚ö†Ô∏è Error", err.message,false);
      }
    }

    document.getElementById("transferBtn").addEventListener("click", transferMoney);
  </script>
</body>
</html>